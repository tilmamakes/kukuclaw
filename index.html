<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#000000" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <title>Talking Interval Clock</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap');
      
      body {
        background-color: #000000;
        color: #ffffff;
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow: hidden; /* Prevent scrolling on body */
      }

      /* Custom Cross Fader Styling */
      input[type=range].fader {
        -webkit-appearance: none; 
        background: transparent; 
        width: 100%;
      }
      
      input[type=range].fader:focus {
        outline: none;
      }
      
      /* The Thumb (Fader Handle) */
      input[type=range].fader::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 36px;
        width: 14px;
        border-radius: 2px;
        background: #ffffff;
        cursor: pointer;
        margin-top: -14px; /* (8px track - 36px thumb) / 2 */
        box-shadow: 0 0 15px rgba(255,255,255,0.4);
        border: 1px solid #e4e4e7;
        position: relative;
        z-index: 10;
      }
      
      /* The Track */
      input[type=range].fader::-webkit-slider-runnable-track {
        width: 100%;
        height: 8px;
        cursor: pointer;
        background: #27272a; /* zinc-800 */
        border: 1px solid #3f3f46; /* zinc-700 */
        border-radius: 4px;
      }

      input[type=range].fader:focus::-webkit-slider-runnable-track {
        background: #27272a;
      }

      /* Custom Scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #18181b; 
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #3f3f46; 
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #52525b; 
      }
    </style>
    
    <script type="importmap">
{
  "imports": {
    "react": "https://unpkg.com/react@18/umd/react.production.min.js",
    "react-dom": "https://unpkg.com/react-dom@18/umd/react-dom.production.min.js",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /************************************************************
         * 1. CONSTANTS
         ************************************************************/
        const INTERVAL_OPTIONS = [1, 2, 3, 4, 5, 6, 10, 12, 15, 20, 30, 60];
        const DEFAULT_INTERVAL = 15;
        const PREFERRED_VOICE_NAMES = ['Zira', 'Microsoft Zira', 'Google US English Female'];

        /************************************************************
         * 2. SERVICES
         ************************************************************/
        const getAvailableVoices = () => {
            return new Promise((resolve) => {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                    return;
                }

                window.speechSynthesis.onvoiceschanged = () => {
                    const updatedVoices = window.speechSynthesis.getVoices();
                    resolve(updatedVoices);
                };
            });
        };

        const selectBestVoice = (voices) => {
            if (voices.length === 0) return null;

            // 1. Priority: Zira
            const zira = voices.find((v) => 
                PREFERRED_VOICE_NAMES.some(name => v.name.includes(name))
            );
            if (zira) return zira;

            // 2. Fallback: Female
            const female = voices.find((v) => 
                v.name.toLowerCase().includes('female') || 
                v.name.toLowerCase().includes('woman') ||
                v.name.toLowerCase().includes('samantha')
            );
            if (female) return female;

            // 3. Default
            const defaultVoice = voices.find(v => v.default);
            return defaultVoice || voices[0];
        };

        const formatTimeForSpeech = (date) => {
            let hours = date.getHours();
            const minutes = date.getMinutes();
            
            // Convert to 12-hour format
            const displayHours = hours % 12 || 12;
            
            if (minutes === 0) {
                return `${displayHours} o'clock`;
            }
            
            if (minutes < 10) {
                // "Eleven Five"
                return `${displayHours} ${minutes}`;
            }
            
            return `${displayHours} ${minutes}`;
        };

        const speakTime = (text, voiceURI, volume) => {
            if (!window.speechSynthesis) return;
            
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.volume = volume;
            utterance.rate = 1;
            utterance.pitch = 1;

            if (voiceURI) {
                const voices = window.speechSynthesis.getVoices();
                const selectedVoice = voices.find(v => v.voiceURI === voiceURI);
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
            }

            window.speechSynthesis.speak(utterance);
        };

        // --- BACKGROUND KEEP-ALIVE UTILS ---
        
        // 1. Web Worker Blob (Runs timer in background thread)
        const workerScript = `
            self.onmessage = function(e) {
                if (e.data === 'start') {
                    setInterval(() => {
                        self.postMessage('tick');
                    }, 1000);
                }
            };
        `;
        const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(workerBlob);

        // 2. Wake Lock (Keeps screen on)
        const requestWakeLock = async () => {
            try {
                if ('wakeLock' in navigator) {
                    const lock = await navigator.wakeLock.request('screen');
                    return lock;
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
            return null;
        };

        // 3. Silent Audio (Keeps audio context active)
        const playSilentAudio = () => {
             const AudioContext = window.AudioContext || window.webkitAudioContext;
             if (!AudioContext) return;
             
             // Check if context already exists to avoid creating multiple
             if (window.keepAliveAudioCtx) return;

             const audioCtx = new AudioContext();
             window.keepAliveAudioCtx = audioCtx; // Store globally

             const oscillator = audioCtx.createOscillator();
             const gainNode = audioCtx.createGain();
             
             // Use a sub-audible frequency (0.1 Hz)
             // Humans hear from 20Hz - 20,000Hz. 0.1Hz is effectively static pressure change.
             oscillator.type = 'sine';
             oscillator.frequency.value = 0.1; 
             
             // Set gain to essentially zero
             // 0.00001 is enough to keep the engine active but is mathematically too small to move the speaker
             gainNode.gain.value = 0.00001; 
             
             oscillator.connect(gainNode);
             gainNode.connect(audioCtx.destination);
             
             oscillator.start();
        };

        /************************************************************
         * 3. ICONS (Lucide replacements)
         ************************************************************/
        const IconChevronDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );
        const IconCheck = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 6 9 17l-5-5"/></svg>
        );
        const IconInfo = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );
        const IconPlay = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
        );
        const IconMic = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        );
        const IconVolume2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        );
        const IconVolumeX = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></svg>
        );
        const IconZap = ({ className }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        );

        /************************************************************
         * 4. UI COMPONENTS
         ************************************************************/
        
        // --- Clock ---
        const Clock = ({ time }) => {
            const formatTime = (date) => {
                let hours = date.getHours();
                const minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                hours = hours % 12;
                hours = hours ? hours : 12;
                
                const strMinutes = minutes < 10 ? '0' + minutes : minutes;
                
                return {
                    timeStr: `${hours}:${strMinutes}`,
                    ampm
                };
            };

            const { timeStr, ampm } = formatTime(time);

            return (
                <div className="flex flex-col items-center justify-center py-2 md:py-6 select-none w-full flex-grow">
                    <div className="relative">
                        <span className="text-8xl md:text-9xl font-bold tracking-tight text-white font-[Inter] leading-none text-center block">
                        {timeStr}
                        </span>
                    </div>
                    <div className="mt-2 md:mt-4">
                        <span className="text-xl md:text-2xl font-medium text-white uppercase tracking-[0.2em] border border-white/20 px-3 py-1 rounded">
                        {ampm}
                        </span>
                    </div>
                </div>
            );
        };

        // --- IntervalSelector ---
        const IntervalSelector = ({ selectedInterval, isOpen, onToggle, onSelect, onClose }) => {
            const dropdownRef = React.useRef(null);

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        onClose();
                    }
                };

                if (isOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isOpen, onClose]);

            return (
                <div className="relative w-full mb-3" ref={dropdownRef}>
                    <button
                        onClick={onToggle}
                        className={`w-full flex items-center justify-center relative px-4 py-5 md:py-6 rounded-lg border transition-all duration-200 group ${
                        isOpen 
                            ? 'bg-zinc-900 border-zinc-600' 
                            : 'bg-black border-zinc-800 hover:border-zinc-600 hover:bg-zinc-900/50'
                        }`}
                    >
                        <div className="flex flex-col items-center w-full">
                            <span className="text-sm md:text-base text-zinc-500 uppercase tracking-widest font-bold mb-1 group-hover:text-zinc-400 transition-colors text-center">Interval</span>
                            <span className="text-3xl md:text-4xl font-medium text-white text-center">Every {selectedInterval} mins</span>
                        </div>
                        <IconChevronDown className={`absolute right-4 md:right-6 w-6 h-6 text-zinc-400 transition-transform duration-200 ${isOpen ? 'rotate-180 text-white' : ''}`} />
                    </button>

                    {isOpen && (
                        <div className="absolute top-full left-0 right-0 mt-2 bg-zinc-950 border border-zinc-800 rounded-lg shadow-[0_10px_40px_rgba(0,0,0,0.5)] z-50 max-h-48 md:max-h-64 overflow-y-auto custom-scrollbar">
                        {INTERVAL_OPTIONS.map((option) => (
                            <button
                                key={option}
                                onClick={(e) => {
                                    e.stopPropagation(); // Prevent closing immediately
                                    onSelect(option);
                                }}
                                className={`w-full flex items-center justify-center relative px-6 py-4 md:py-5 text-center border-b border-zinc-900 last:border-0 hover:bg-zinc-900 transition-colors group ${
                                    selectedInterval === option ? 'bg-zinc-900/50' : ''
                                }`}
                            >
                            <span className={`text-xl md:text-2xl ${selectedInterval === option ? 'text-white font-medium' : 'text-zinc-400 group-hover:text-zinc-200'}`}>
                                {option} Minutes
                            </span>
                            {selectedInterval === option && <IconCheck className="absolute right-6 w-5 h-5 text-white" />}
                            </button>
                        ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- AboutPanel ---
        const AboutPanel = ({ settings, voices, isOpen, onToggle, onClose, onUpdateSettings, onTestVoice }) => {
            const dropdownRef = React.useRef(null);
            const [isVoiceListOpen, setIsVoiceListOpen] = React.useState(false);

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        onClose();
                        setIsVoiceListOpen(false);
                    }
                };

                if (isOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isOpen, onClose]);

            React.useEffect(() => {
                if (!isOpen) setIsVoiceListOpen(false);
            }, [isOpen]);

            const selectedVoiceName = voices.find(v => v.voiceURI === settings.selectedVoiceURI)?.name || "Default Voice";

            return (
                <div className="relative w-full mb-3" ref={dropdownRef}>
                    <button
                        onClick={onToggle}
                        className={`w-full flex items-center justify-center relative px-4 py-5 md:py-6 rounded-lg border transition-all duration-200 group ${
                        isOpen 
                            ? 'bg-zinc-900 border-zinc-600' 
                            : 'bg-black border-zinc-800 hover:border-zinc-600 hover:bg-zinc-900/50'
                        }`}
                    >
                        <div className="flex items-center justify-center gap-3 w-full">
                            <IconInfo className="w-6 h-6 md:w-7 md:h-7 text-zinc-400 group-hover:text-white transition-colors" /> 
                            <span className="text-2xl md:text-3xl font-medium text-white text-center">Settings</span>
                        </div>
                        <IconChevronDown className={`absolute right-4 md:right-6 w-6 h-6 text-zinc-400 transition-transform duration-200 ${isOpen ? 'rotate-180 text-white' : ''}`} />
                    </button>

                    {isOpen && (
                        <div className="absolute bottom-full mb-2 left-0 right-0 bg-zinc-950 border border-zinc-800 rounded-lg shadow-[0_20px_50px_rgba(0,0,0,0.8)] z-50 p-6 flex flex-col gap-6 animate-in fade-in slide-in-from-bottom-2 duration-200 text-center">
                        
                        {/* 1. Toggle */}
                        <div 
                            onClick={(e) => {
                                e.stopPropagation();
                                onUpdateSettings({ enabled: !settings.enabled });
                            }}
                            className="flex items-center justify-center gap-4 cursor-pointer group hover:opacity-90 transition-opacity"
                        >
                            <label className="text-zinc-300 text-lg font-medium cursor-pointer group-hover:text-white transition-colors text-center">Enable Voice Announcement</label>
                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 ${settings.enabled ? 'border-white bg-transparent' : 'border-zinc-600'}`}>
                                {settings.enabled && (
                                    <div className="w-3 h-3 rounded-full bg-white shadow-[0_0_8px_rgba(255,255,255,0.8)]" />
                                )}
                            </div>
                        </div>

                        <div className="h-px bg-zinc-900 w-full" />

                        {/* 2. Test Button */}
                        <button 
                            onClick={(e) => {
                                e.stopPropagation();
                                onTestVoice();
                            }}
                            className="w-full flex items-center justify-center gap-2 bg-white text-black font-bold py-4 text-lg rounded hover:bg-zinc-200 hover:scale-[1.01] active:scale-[0.99] transition-all"
                        >
                            <IconPlay className="w-5 h-5 fill-current" /> 
                            Test Current Voice
                        </button>

                        {/* 3. Voice Selection */}
                        <div className="flex flex-col gap-3">
                            <span className="text-xs text-zinc-500 uppercase tracking-widest font-bold text-center">Voice Selection</span>
                            <div className="relative">
                                <button 
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        setIsVoiceListOpen(!isVoiceListOpen);
                                    }}
                                    className="w-full relative bg-zinc-900 border border-zinc-800 p-4 rounded text-zinc-300 flex justify-center items-center hover:bg-zinc-800 transition-colors hover:text-white"
                                >
                                    <div className="flex items-center justify-center gap-2 overflow-hidden px-6 w-full">
                                        <IconMic className="w-5 h-5 flex-shrink-0 text-zinc-500" />
                                        <span className="truncate text-lg text-center">{selectedVoiceName}</span>
                                    </div>
                                    <IconChevronDown className={`absolute right-4 w-5 h-5 transition-transform ${isVoiceListOpen ? 'rotate-180' : ''}`} />
                                </button>
                                
                                {isVoiceListOpen && (
                                    <div className="absolute bottom-full left-0 right-0 mb-2 max-h-48 overflow-y-auto bg-zinc-900 border border-zinc-700 rounded shadow-xl z-[60] custom-scrollbar">
                                        {voices.map(voice => (
                                            <button
                                                key={voice.voiceURI}
                                                className={`w-full text-center px-4 py-3 text-lg border-b border-zinc-800 last:border-0 transition-colors ${
                                                    settings.selectedVoiceURI === voice.voiceURI 
                                                        ? 'bg-zinc-800 text-white font-medium' 
                                                        : 'text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200'
                                                }`}
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    onUpdateSettings({ selectedVoiceURI: voice.voiceURI });
                                                    setIsVoiceListOpen(false);
                                                }}
                                            >
                                                {voice.name}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        </div>
                    )}
                </div>
            );
        };

        // --- VolumeSlider ---
        const VolumeSlider = ({ volume, onChange }) => {
            return (
                <div className="w-full mt-auto pt-6 pb-2 flex flex-col items-center">
                    <span className="text-xs uppercase tracking-[0.2em] font-bold text-zinc-500 mb-4 select-none">Master Volume</span>
                    
                    <div className="w-full flex items-center gap-4 mb-2">
                        <button 
                            onClick={(e) => { e.stopPropagation(); onChange(volume === 0 ? 0.5 : 0); }} 
                            className="text-zinc-500 hover:text-white transition-colors focus:outline-none"
                        >
                            {volume === 0 ? <IconVolumeX className="w-8 h-8" /> : <IconVolume2 className="w-8 h-8" />}
                        </button>
                        <div className="relative flex-grow h-10 flex items-center">
                            <input
                            type="range"
                            min="0"
                            max="1"
                            step="0.01"
                            value={volume}
                            onChange={(e) => { e.stopPropagation(); onChange(parseFloat(e.target.value)); }}
                            className="fader"
                            aria-label="Volume Control"
                            />
                        </div>
                    </div>
                    
                    <span className="text-sm font-mono text-zinc-400 select-none">{Math.round(volume * 100)}%</span>
                </div>
            );
        };

        /************************************************************
         * 5. MAIN APP
         ************************************************************/
        const App = () => {
            const [currentTime, setCurrentTime] = React.useState(new Date());
            const [interval, setIntervalOption] = React.useState(DEFAULT_INTERVAL);
            const [voices, setVoices] = React.useState([]);
            const [isKeepAliveActive, setIsKeepAliveActive] = React.useState(false);
            
            const [settings, setSettings] = React.useState({
                enabled: true,
                volume: 1.0,
                selectedVoiceURI: null,
            });

            const [menuState, setMenuState] = React.useState({
                interval: false,
                about: false,
            });

            const lastSpokenTimeRef = React.useRef("");
            const workerRef = React.useRef(null);
            const wakeLockRef = React.useRef(null);

            // Initialize Voices
            React.useEffect(() => {
                const initVoices = async () => {
                    const availableVoices = await getAvailableVoices();
                    setVoices(availableVoices);
                    
                    const bestVoice = selectBestVoice(availableVoices);
                    if (bestVoice) {
                        setSettings(prev => ({ ...prev, selectedVoiceURI: bestVoice.voiceURI }));
                    }
                };
                initVoices();
            }, []);

            // ACTIVATE KEEP ALIVE on first interaction
            const activateKeepAlive = React.useCallback(async () => {
                if (isKeepAliveActive) return;

                // 1. Start Silent Audio Loop
                try {
                    playSilentAudio();
                } catch(e) { console.log("Audio ctx error", e)}

                // 2. Request Wake Lock
                const lock = await requestWakeLock();
                wakeLockRef.current = lock;

                // 3. Initialize Worker for Timing
                if (!workerRef.current) {
                    workerRef.current = new Worker(workerUrl);
                    workerRef.current.onmessage = (e) => {
                         if (e.data === 'tick') {
                             handleTick();
                         }
                    };
                    workerRef.current.postMessage('start');
                }

                setIsKeepAliveActive(true);
            }, [isKeepAliveActive]);

            const handleTick = () => {
                const now = new Date();
                setCurrentTime(now); // Updates UI
                
                // We access the LATEST state via refs or direct access inside the worker callback scope
                // But in React functional components, this `checkAndSpeak` needs to access current settings.
                // The cleanest way is to just set state, and let a useEffect react to the time change.
                // However, useEffect might be throttled? No, the state update triggers re-render on main thread.
                // BUT, to be safe, we call the logic directly here if we can access the refs.
                // For simplicity in this structure, we will rely on the state update triggering the effect below.
            };

            // React to Time Change (triggered by Worker Tick)
            React.useEffect(() => {
               if (settings.enabled) {
                   checkAndSpeak(currentTime);
               }
            }, [currentTime, settings.enabled, interval, settings.volume, settings.selectedVoiceURI]);

            const checkAndSpeak = (time) => {
                const minutes = time.getMinutes();
                const seconds = time.getSeconds();
                
                const isIntervalMatch = minutes % interval === 0;
                
                // Allow a small buffer for the worker tick (0 or 1 second)
                if (isIntervalMatch && seconds < 2) {
                    const timeSignature = `${time.getHours()}:${minutes}`;
                    
                    if (lastSpokenTimeRef.current !== timeSignature) {
                        speakCurrentTime(time);
                        lastSpokenTimeRef.current = timeSignature;
                    }
                }
            };

            const speakCurrentTime = React.useCallback((time = new Date()) => {
                const text = formatTimeForSpeech(time);
                speakTime(text, settings.selectedVoiceURI, settings.volume);
            }, [settings.selectedVoiceURI, settings.volume]);

            // Interaction Handler Wrapper
            const handleInteraction = () => {
                activateKeepAlive();
            };

            const toggleMenu = (menu) => {
                handleInteraction();
                setMenuState(prev => ({
                    interval: menu === 'interval' ? !prev.interval : false,
                    about: menu === 'about' ? !prev.about : false,
                }));
            };

            const updateSettings = (newVals) => {
                handleInteraction();
                setSettings(prev => ({ ...prev, ...newVals }));
            }

            return (
                <div 
                    className="h-[100dvh] w-screen bg-black text-white flex flex-col items-center justify-center p-2 md:p-4 overflow-hidden"
                    onClick={handleInteraction} // Catch-all interaction handler
                >
                    <div className="w-full max-w-[420px] h-full max-h-[90vh] md:max-h-[800px] bg-black border border-zinc-800 rounded-2xl shadow-[0_0_80px_rgba(255,255,255,0.03)] flex flex-col relative overflow-visible transition-all duration-300">
                        
                        <div className="flex-grow flex flex-col justify-center items-center px-4 min-h-0">
                            <Clock time={currentTime} />
                        </div>

                        <div className="px-4 md:px-6 py-2 flex flex-col flex-shrink-0 relative z-20">
                            <IntervalSelector 
                                selectedInterval={interval}
                                isOpen={menuState.interval}
                                onToggle={() => toggleMenu('interval')}
                                onSelect={(val) => {
                                    handleInteraction();
                                    setIntervalOption(val);
                                    setMenuState({ interval: false, about: false });
                                }}
                                onClose={() => setMenuState(prev => ({ ...prev, interval: false }))}
                            />

                            <AboutPanel 
                                settings={settings}
                                voices={voices}
                                isOpen={menuState.about}
                                onToggle={() => toggleMenu('about')}
                                onClose={() => setMenuState(prev => ({ ...prev, about: false }))}
                                onUpdateSettings={updateSettings}
                                onTestVoice={() => {
                                    handleInteraction();
                                    speakCurrentTime(currentTime);
                                }}
                            />
                        </div>

                        <div className="px-6 md:px-8 pb-4 pt-2 mt-auto border-t border-zinc-900/50 flex-shrink-0">
                            <VolumeSlider 
                                volume={settings.volume}
                                onChange={(vol) => {
                                    handleInteraction();
                                    setSettings(prev => ({ ...prev, volume: vol }))
                                }}
                            />
                            <div className="mt-2 mb-2 text-center text-zinc-800 text-[10px] tracking-widest uppercase font-bold select-none flex items-center justify-center gap-2">
                                <span>Audio Interval System</span>
                                {isKeepAliveActive && <div className="w-1.5 h-1.5 rounded-full bg-green-900 animate-pulse" title="Keep-Alive Active"></div>}
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        /************************************************************
         * 6. RENDER
         ************************************************************/
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
    
    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.log('SW Failed', err));
            });
        }
    </script>
</body>
</html>
